---

- import_tasks: setup.yaml

- name: Set sys auth to TACACS+
  bigip_sys_auth:
    type: tacacs
    authentication: use-all-servers
    protocol_name: ip
    secret: $XXXXXXXXXXXXXXXXXXXX==
    servers:
      - 10.10.10.10
      - 10.10.10.11
    service_name: ppp
    use_for_auth: yes
    update_secret: on_create
  register: result

- name: Assert Set sys auth to TACACS+
  assert:
    that:
      - result is changed
      - result is success

- name: Set sys auth to TACACS+ - Idempotent check
  bigip_sys_auth:
    type: tacacs
    authentication: use-all-servers
    protocol_name: ip
    secret: $XXXXXXXXXXXXXXXXXXXX==
    servers:
      - 10.10.10.10
      - 10.10.10.11
    service_name: ppp
    use_for_auth: yes
    update_secret: on_create
  register: result

- name: Assert Set sys auth to TACACS+ - Idempotent check
  assert:
    that:
      - result is not changed
      - result is success

- name: Set sys auth to TACACS+ - update_secret always
  bigip_sys_auth:
    type: tacacs
    authentication: use-all-servers
    protocol_name: ip
    secret: $XXXXXXXXXXXXXXXXXXXX==
    servers:
      - 10.10.10.10
      - 10.10.10.11
    service_name: ppp
    use_for_auth: yes
    update_secret: always
  register: result

- name: Assert Set sys auth to TACACS+ - update_secret always
  assert:
    that:
      - result is changed
      - result is success

- name: Set sys auth to TACACS+ - default update_secret always
  bigip_sys_auth:
    type: tacacs
    authentication: use-all-servers
    protocol_name: ip
    secret: $XXXXXXXXXXXXXXXXXXXX==
    servers:
      - 10.10.10.10
      - 10.10.10.11
    service_name: ppp
    use_for_auth: yes
  register: result

- name: Assert Set sys auth to TACACS+ - default update_secret always
  assert:
    that:
      - result is changed
      - result is success

- name: Change servers
  bigip_sys_auth:
    type: tacacs
    servers:
      - 11.11.11.11
  register: result

- name: Assert Change servers
  assert:
    that:
      - result is changed
      - result is success

- name: Change servers - Idempotent check
  bigip_sys_auth:
    type: tacacs
    servers:
      - 11.11.11.11
  register: result

- name: Assert Change servers - Idempotent check
  assert:
    that:
      - result is not changed
      - result is success

- name: Change servers, specific port, same data structure
  bigip_sys_auth:
    type: tacacs
    servers:
      - address: 11.11.11.11
        port: 8080
      - address: 12.12.12.12
        port: 1234
  register: result

- name: Assert Change servers
  assert:
    that:
      - result is changed
      - result is success

- name: Change servers, specific port, same data structure - Idempotent check
  bigip_sys_auth:
    type: tacacs
    servers:
      - address: 11.11.11.11
        port: 8080
      - address: 12.12.12.12
        port: 1234
  register: result

- name: Assert Change servers, specific port, same data structure - Idempotent check
  assert:
    that:
      - result is not changed
      - result is success

- name: Change servers, specific port, different data structure
  bigip_sys_auth:
    type: tacacs
    servers:
      - 13.13.13.13
      - address: 14.14.14.14
        port: 1234
  register: result

- name: Assert Change servers, specific port, different data structure
  assert:
    that:
      - result is changed
      - result is success

- name: Change servers, specific port, different data structure - Idempotent check
  bigip_sys_auth:
    type: tacacs
    servers:
      - 13.13.13.13
      - address: 14.14.14.14
        port: 1234
  register: result

- name: Assert Change servers, specific port, different data structure - Idempotent check
  assert:
    that:
      - result is not changed
      - result is success

- name: Change service
  bigip_sys_auth:
    type: tacacs
    service_name: shell
  register: result

- name: Assert Change service
  assert:
    that:
      - result is changed
      - result is success

- name: Change service - Idempotent check
  bigip_sys_auth:
    type: tacacs
    service_name: shell
  register: result

- name: Assert Change service - Idempotent check
  assert:
    that:
      - result is not changed
      - result is success

- name: Change protocol
  bigip_sys_auth:
    type: tacacs
    protocol_name: ftp
  register: result

- name: Assert Change protocol
  assert:
    that:
      - result is changed
      - result is success

- name: Change protocol - Idempotent check
  bigip_sys_auth:
    type: tacacs
    protocol_name: ftp
  register: result

- name: Assert Change protocol - Idempotent check
  assert:
    that:
      - result is not changed
      - result is success

- name: Change authentication, use-first-server
  bigip_sys_auth:
    type: tacacs
    authentication: use-first-server
  register: result

- name: Assert Change authentication, use-first-server
  assert:
    that:
      - result is changed
      - result is success

- name: Change authentication, use-first-server - Idempotent check
  bigip_sys_auth:
    type: tacacs
    authentication: use-first-server
  register: result

- name: Assert Change authentication, use-first-server - Idempotent check
  assert:
    that:
      - result is not changed
      - result is success

- name: Change authentication, use-all-servers
  bigip_sys_auth:
    type: tacacs
    authentication: use-all-servers
  register: result

- name: Assert Change authentication, use-all-servers
  assert:
    that:
      - result is changed
      - result is success

- name: Change authentication, use-all-servers - Idempotent check
  bigip_sys_auth:
    type: tacacs
    authentication: use-all-servers
  register: result

- name: Assert Change authentication, use-all-servers - Idempotent check
  assert:
    that:
      - result is not changed
      - result is success

- name: Remove auth, resetting to local
  bigip_sys_auth:
    type: tacacs
    state: absent
  register: result

- name: Assert Remove auth, resetting to local
  assert:
    that:
      - result is changed
      - result is success

- name: Remove auth, resetting to local - Idempotent check
  bigip_sys_auth:
    type: tacacs
    state: absent
  register: result

- name: Assert Remove auth, resetting to local - Idempotent check
  assert:
    that:
      - result is not changed
      - result is success

- name: Check if local is set
  bigip_sys_auth:
    type: local
    use_for_auth: yes
  register: result

- name: Assert Check if local is set
  assert:
    that:
      - result is not changed
      - result is success

- import_tasks: teardown.yaml
